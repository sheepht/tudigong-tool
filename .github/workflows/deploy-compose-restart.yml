# 如果在 branch main push 時，修改的是 dev/docker-compose.yml，就把 dev/docker-compose.yml 傳到 dev 環境，如果是 prd/docker-compose.yml，就把 prd/docker-compose.yml 傳到 prd 環境。
name: deploy Compose and restart

on:
  push:
    branches:
      - main

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: set .env
        run: |
          echo "PING_URL_WEB=${{secrets.PING_URL_WEB}}" >> dev/.env
          echo "PING_URL_SERVICE=${{secrets.PING_URL_SERVICE}}" >> dev/.env

      - name: set healthcheck permission
        run: |
          chmod +x dev/healthcheck-web.sh
          chmod +x dev/healthcheck-service.sh

      - name: Sync
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          # dev/docker-compose.yml, dev/healtcheck.sh
          source: dev/*
          target: ~/web/dev
          strip_components: 1

      - name: restart web, db, service, healthcheck-web-reporter, healthcheck-service-reporter
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          port: 22
          script: |
            cd ~/web/dev
            docker compose restart web
            docker compose restart db
            docker compose restart service
            docker compose restart healthcheck-web-reporter
            docker compose restart healthcheck-service-reporter

  # 這個 job 暫時不用
  deploy-prd:
    runs-on: ubuntu-latest
    environment: prd
    if: false # 這樣這個 job 永遠不會執行

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          source: prd/docker-compose.yml
          target: ~/web/prd # 這邊可能到時要改
          strip_components: 1
